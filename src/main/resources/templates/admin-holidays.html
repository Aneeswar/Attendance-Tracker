<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Holiday Management - AttenTrack Admin</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #0f172a;
            --accent: #4f46e5;
            --background: #f1f5f9;
            --white: #ffffff;
            --text-main: #1e293b;
            --text-muted: #64748b;
            --success: #10b981;
            --danger: #ef4444;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Inter', sans-serif; background: var(--background); color: var(--text-main); min-height: 100vh; }

        .navbar {
            background: var(--primary);
            color: white;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .navbar-brand { font-size: 1.25rem; font-weight: 800; display: flex; align-items: center; gap: 0.75rem; }
        .navbar-brand i { color: #818cf8; }

        .container { max-width: 1200px; margin: 2rem auto; padding: 0 1.5rem; }

        .dashboard-grid {
            display: grid;
            grid-template-columns: 400px 1fr;
            gap: 2rem;
        }

        .card {
            background: white;
            border-radius: 1rem;
            border: 1px solid #e2e8f0;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .card-header {
            padding: 1.5rem;
            border-bottom: 1px solid #f1f5f9;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .card-header h2 { font-size: 1.125rem; font-weight: 700; color: var(--text-main); }

        .card-body { padding: 1.5rem; }

        .form-tabs {
            display: flex;
            background: #f1f5f9;
            padding: 0.25rem;
            border-radius: 0.75rem;
            margin-bottom: 1.5rem;
        }

        .tab-btn {
            flex: 1;
            padding: 0.5rem;
            border: none;
            background: none;
            font-size: 0.8125rem;
            font-weight: 700;
            color: var(--text-muted);
            cursor: pointer;
            border-radius: 0.5rem;
            transition: all 0.2s;
        }

        .tab-btn.active {
            background: white;
            color: var(--accent);
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .form-group { margin-bottom: 1.25rem; }
        .form-group label { display: block; font-size: 0.8125rem; font-weight: 700; color: var(--text-main); margin-bottom: 0.5rem; }
        .form-group input, .form-group select {
            width: 100%;
            padding: 0.75rem;
            border-radius: 0.75rem;
            border: 1px solid #e2e8f0;
            font-family: inherit;
            font-size: 0.875rem;
            background: #f8fafc;
        }

        .btn-primary {
            width: 100%;
            padding: 0.875rem;
            border: none;
            border-radius: 0.75rem;
            background: var(--accent);
            color: white;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }
        .btn-primary:hover { background: #4338ca; transform: translateY(-1px); }

        .holiday-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1.25rem;
        }

        .holiday-card {
            background: white;
            border-radius: 1rem;
            border: 1px solid #e2e8f0;
            padding: 1.25rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
            position: relative;
            transition: transform 0.2s;
        }
        .holiday-card:hover { transform: translateY(-2px); border-color: var(--accent); }

        .holiday-type {
            font-size: 0.7rem;
            font-weight: 800;
            padding: 0.25rem 0.5rem;
            border-radius: 0.5rem;
            text-transform: uppercase;
            width: fit-content;
        }
        .type-public { background: #eef2ff; color: #4f46e5; }
        .type-academic { background: #f0f9ff; color: #0ea5e9; }
        .type-restricted { background: #fff7ed; color: #f59e0b; }

        .holiday-name { font-weight: 800; font-size: 1rem; color: var(--text-main); }
        .holiday-date { font-size: 0.875rem; color: var(--text-muted); display: flex; align-items: center; gap: 0.5rem; }

        .del-btn {
            position: absolute;
            top: 1rem;
            right: 1rem;
            color: #cbd5e1;
            background: none;
            border: none;
            cursor: pointer;
            transition: color 0.2s;
        }
        .del-btn:hover { color: var(--danger); }

        .toast-container { position: fixed; bottom: 2rem; right: 2rem; z-index: 2000; }
        .toast {
            background: var(--primary);
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 1rem;
            font-weight: 600;
            margin-top: 0.75rem;
            border-left: 4px solid var(--accent);
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1);
            animation: slideIn 0.3s ease-out;
        }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

        @media (max-width: 1024px) {
            .dashboard-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="navbar">
        <div class="navbar-brand">
            <i class="fas fa-calendar-star"></i>
            <span>AttenTrack Admin</span>
        </div>
        <div>
            <a href="/admin-dashboard" style="color: white; text-decoration: none; font-size: 0.875rem; font-weight: 700;">
                <i class="fas fa-arrow-left"></i> Dashboard
            </a>
        </div>
    </div>

    <div class="container">
        <div class="dashboard-grid">
            <!-- Form Section -->
            <div class="card" style="height: fit-content;">
                <div class="card-header">
                    <h2>Manage Holidays</h2>
                </div>
                <div class="card-body">
                    <div class="form-tabs">
                        <button class="tab-btn active" onclick="switchTab('single')">Single Date</button>
                        <button class="tab-btn" onclick="switchTab('range')">Date Range</button>
                    </div>

                    <!-- Single Holiday Form -->
                    <div id="singleForm">
                        <div class="form-group">
                            <label>Holiday Name</label>
                            <input type="text" id="holidayName" placeholder="e.g., Christmas">
                        </div>
                        <div class="form-group">
                            <label>Date</label>
                            <input type="date" id="holidayDate">
                        </div>
                        <div class="form-group">
                            <label>Type</label>
                            <select id="holidayType">
                                <option value="PUBLIC">Public Holiday</option>
                                <option value="ACADEMIC">Academic Holiday</option>
                                <option value="RESTRICTED">Restricted Holiday</option>
                            </select>
                        </div>
                        <button class="btn-primary" onclick="addHoliday()">
                            <i class="fas fa-plus"></i> Add Holiday
                        </button>
                    </div>

                    <!-- Range Form -->
                    <div id="rangeForm" style="display: none;">
                        <div class="form-group">
                            <label>Range Name</label>
                            <input type="text" id="rangeName" placeholder="e.g., Winter Break">
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div class="form-group">
                                <label>Start Date</label>
                                <input type="date" id="rangeStartDate">
                            </div>
                            <div class="form-group">
                                <label>End Date</label>
                                <input type="date" id="rangeEndDate">
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Type</label>
                            <select id="rangeType">
                                <option value="ACADEMIC">Academic Holiday</option>
                                <option value="PUBLIC">Public Holiday</option>
                                <option value="RESTRICTED">Restricted Holiday</option>
                            </select>
                        </div>
                        <button class="btn-primary" onclick="addHolidayRange()">
                            <i class="fas fa-calendar-plus"></i> Add Range
                        </button>
                    </div>
                </div>
            </div>

            <!-- List Section -->
            <div>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                    <h2 style="font-size: 1.25rem; font-weight: 800;">Academic Holidays</h2>
                    <span id="holidayCount" style="padding: 0.25rem 0.75rem; background: var(--accent); color: white; border-radius: 2rem; font-size: 0.75rem; font-weight: 800;">0 listed</span>
                </div>

                <div class="holiday-grid" id="holidayList">
                    <!-- Loaded via JS -->
                </div>
            </div>
        </div>
    </div>

    <div class="toast-container" id="toastContainer"></div>

    <script>
        const token = localStorage.getItem('jwtToken');
        if (!token) window.location.href = '/login?mode=admin';

        document.addEventListener('DOMContentLoaded', loadHolidays);

        function switchTab(type) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
            
            if (type === 'single') {
                document.getElementById('singleForm').style.display = 'block';
                document.getElementById('rangeForm').style.display = 'none';
            } else {
                document.getElementById('singleForm').style.display = 'none';
                document.getElementById('rangeForm').style.display = 'block';
            }
        }

        async function loadHolidays() {
            try {
                const res = await fetch('/api/admin/holidays', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const holidays = await res.json();
                renderHolidays(holidays);
            } catch (e) {
                showToast('Failed to load holidays');
            }
        }

        function groupHolidaysByRange(holidays) {
            if (!holidays || holidays.length === 0) return [];
            holidays.sort((a, b) => new Date(a.date) - new Date(b.date));
            const grouped = [];
            let currentGroup = null;
            
            for (const h of holidays) {
                const currentDate = new Date(h.date);
                if (!currentGroup) {
                    currentGroup = { name: h.name, type: h.type, startDate: h.date, endDate: h.date, ids: [h.id], count: 1 };
                } else {
                    const lastDate = new Date(currentGroup.endDate);
                    const nextDay = new Date(lastDate);
                    nextDay.setDate(nextDay.getDate() + 1);
                    if (h.name === currentGroup.name && currentDate.getTime() === nextDay.getTime()) {
                        currentGroup.endDate = h.date;
                        currentGroup.ids.push(h.id);
                        currentGroup.count++;
                    } else {
                        grouped.push(currentGroup);
                        currentGroup = { name: h.name, type: h.type, startDate: h.date, endDate: h.date, ids: [h.id], count: 1 };
                    }
                }
            }
            if (currentGroup) grouped.push(currentGroup);
            return grouped;
        }

        function renderHolidays(holidays) {
            const list = document.getElementById('holidayList');
            document.getElementById('holidayCount').textContent = `${holidays.length} listed`;
            
            if (!holidays.length) {
                list.innerHTML = `<div style="grid-column: 1/-1; text-align: center; padding: 4rem; color: var(--text-muted);">
                    <i class="fas fa-calendar-times" style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.2;"></i>
                    <p style="font-weight: 600;">No holidays configured for this session.</p>
                </div>`;
                return;
            }

            const grouped = groupHolidaysByRange(holidays);
            list.innerHTML = grouped.map(g => `
                <div class="holiday-card">
                    <button class="del-btn" onclick="deleteHolidayGroup([${g.ids.join(',')}])"><i class="fas fa-times-circle"></i></button>
                    <span class="holiday-type type-${g.type.toLowerCase()}">${g.type}</span>
                    <div class="holiday-name">${g.name}</div>
                    <div class="holiday-date">
                        <i class="far fa-calendar-alt"></i>
                        ${g.startDate === g.endDate ? g.startDate : `${g.startDate}  ${g.endDate}`}
                    </div>
                </div>
            `).join('');
        }

        async function addHoliday() {
            const name = document.getElementById('holidayName').value;
            const date = document.getElementById('holidayDate').value;
            const type = document.getElementById('holidayType').value;
            if(!name || !date) return showToast('Fill all fields');

            const res = await fetch('/api/admin/holidays', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                body: JSON.stringify({ name, date, type })
            });
            if(res.ok) {
                showToast('Holiday added!');
                document.getElementById('holidayName').value = '';
                loadHolidays();
            }
        }

        async function addHolidayRange() {
            const name = document.getElementById('rangeName').value;
            const start = document.getElementById('rangeStartDate').value;
            const end = document.getElementById('rangeEndDate').value;
            const type = document.getElementById('rangeType').value;
            if(!name || !start || !end) return showToast('Fill all fields');

            const res = await fetch('/api/admin/holidays/range', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                body: JSON.stringify({ name, startDate: start, endDate: end, type })
            });
            if(res.ok) {
                showToast('Range added!');
                document.getElementById('rangeName').value = '';
                loadHolidays();
            } else {
                showToast('Failed to add range');
            }
        }

        async function deleteHolidayGroup(ids) {
            if(!confirm('Delete this holiday entry?')) return;
            for(let id of ids) {
                await fetch(`/api/admin/holidays/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
            }
            showToast('Deleted');
            loadHolidays();
        }

        function showToast(msg) {
            const t = document.createElement('div');
            t.className = 'toast';
            t.textContent = msg;
            document.getElementById('toastContainer').appendChild(t);
            setTimeout(() => t.remove(), 3000);
        }
    </script>
</body>
</html>
